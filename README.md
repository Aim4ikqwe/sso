# SSO (Single Sign-On) Service

Это сервис однократной авторизации (SSO), реализованный на языке Go, предоставляющий функциональность аутентификации через gRPC.

## Функции

- Регистрация и вход пользователя
- Аутентификация на основе JWT с токенами доступа и обновления
- gRPC интерфейс для операций аутентификации
- Хранение данных в PostgreSQL
- Структурированное логирование с помощью logrus

## Архитектура

Сервис следует модульной архитектуре со следующими основными компонентами:

- **cmd/main.go**: Точка входа в приложение
- **internal/app/**: Основная логика приложения
- **internal/server/grpc/**: Реализация gRPC-сервера
- **internal/services/auth/**: Бизнес-логика аутентификации
- **internal/storage/**: Реализация хранения данных в базе
- **internal/jwt/**: Генерация и парсинг JWT-токенов
- **internal/model/**: Модели данных

## Установка

1. Убедитесь, что у вас установлен Go
2. Установите зависимости: `go mod tidy`
3. Настройте базу данных PostgreSQL
4. Настройте приложение в `config/config.toml`
5. Запустите приложение: `go run cmd/main.go`

## Конфигурация

Приложение использует файл конфигурации TOML, расположенный в `config/config.toml`. Вы можете настроить:

- Строку подключения к базе данных
- Порт gRPC-сервера
- Окружение (local, staging, production)
- Время жизни токенов (TTL)

## API-методы

Сервис предоставляет следующие gRPC-методы:

- `Login`: Аутентификация пользователя по email и паролю
- `Register`: Создание новой учетной записи пользователя
- `Logout`: Инвалидация сессии пользователя
- `RefreshToken`: Генерация новых токенов доступа/обновления

## Логирование

Приложение использует logrus для структурированного логирования. Уровни логирования различаются в зависимости от окружения:

- Локальное: уровень отладки (Debug)
- Тестирование: уровень информации (Info)
- Продакшн: уровень ошибок (Error)

## Безопасность

- Пароли хэшируются с использованием bcrypt
- JWT-токены с настраиваемым сроком действия
- Проверка входных данных на всех концах
- Безопасная обработка токенов

## Миграции базы данных

Для управления схемой базы данных используются миграции, которые находятся в директории `migrations/`. Миграции позволяют управлять структурой базы данных и обеспечивают согласованность схемы в разных окружениях.

Для применения миграций можно использовать инструмент `migrate`:

```bash
# Установка migrate CLI
go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

# Применение миграций
migrate -path ./migrations -database 'postgres://username:password@localhost:5432/dbname?sslmode=disable' up
```

Или выполнить SQL-файл напрямую в вашей PostgreSQL базе данных.

## Схема базы данных

Сервис требует базу данных PostgreSQL с таблицами для:

- Пользователей (email, хэш пароля, имя пользователя, app_id)
- Приложений (id, имя, секрет)
- Сессий (user_id, refresh_token)

## Обработка ошибок

Сервис реализует комплексную обработку ошибок с соответствующими кодами статуса gRPC и подробными сообщениями об ошибках.
